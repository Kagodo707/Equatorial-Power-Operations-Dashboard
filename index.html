<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Equatorial Power Operations Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
 <style>
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
  body { background-color: #f5f7fa; color: #333; padding: 20px; }
  .dashboard-container { max-width: 1400px; margin: 0 auto; }
  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0; }
  h1 { color: #2c3e50; font-weight: 700; }
  .controls { display: flex; gap: 12px; flex-wrap: wrap; }
  .controls select { padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }

  .summary { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 16px; margin: 24px 0; }
  .card { background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
  .card h3 { font-size: 13px; color: #6b7280; margin-bottom: 8px; }
  .card .big { font-size: 24px; font-weight: 700; color: #111827; }

  /* Charts layout */
  .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 18px; }
  .chart-container { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
  .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #374151; }

  /* Key fix: explicitly size canvases to avoid vertical overflow */
  .chart-canvas {
    width: 100% !important;
    max-width: 100%;
    height: 320px !important;
    display: block;
  }

  .data-table { width: 100%; border-collapse: collapse; background: white; margin-top: 24px; }
  .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
  .data-table th { background-color: #2c3e50; color: white; font-weight: 500; }
  .data-table tr:hover { background-color: #f5f7fa; }

  @media (max-width: 900px) {
    .charts-grid { grid-template-columns: 1fr; }
    .chart-canvas { height: 280px !important; }
  }
</style>
a (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } .chart-container { height: auto; } }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <header>
      <h1>Equatorial Power Operations Dashboard</h1>
      <div class="controls">
        <select id="siteFilter">
          <option value="__ALL__">All sites</option>
        </select>
        <select id="monthFilter">
          <option value="__ALL__">All months</option>
        </select>
      </div>
    </header>

    <section class="summary">
      <div class="card"><h3>Total Revenue (USD)</h3><div id="totalRevenue" class="big">—</div></div>
      <div class="card"><h3>Total Energy (kWh)</h3><div id="totalEnergy" class="big">—</div></div>
      <div class="card"><h3>Active Customers</h3><div id="totalCustomers" class="big">—</div></div>
      <div class="card"><h3>Average ARPU (USD)</h3><div id="avgARPU" class="big">—</div></div>
    </section>

    <section class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Monthly Revenue</div>
        <canvas id="revenueChart" height=""></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Revenue by Site</div>
        <canvas id="siteRevenueChart" height="240"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Planned vs Consumed Energy (kWh)</div>
        <canvas id="energyChart" height="240"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Active Customers by Site</div>
        <canvas id="customersChart" height="240"></canvas>
      </div>
    </section>

    <table class="data-table" id="dataTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    // ====== CONFIG: Google Sheet CSV ======
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/1Jl32qnvVwJKd7QduBCiMchIxZtbzHUTHOrKM2YWPdJw/export?format=csv&gid=1837089544";

    // ====== STATE ======
    let allData = [];
    let filteredData = [];
    let revenueChart, siteRevenueChart, energyChart, customersChart;

    // ====== UTILS ======
    const currencyToNumber = (val) => {
      if (val === null || val === undefined) return 0;
      if (typeof val === "number") return val;
      const s = String(val).replace(/[\$,]/g, "").trim();
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    };

    const intOrZero = (val) => {
      if (val === null || val === undefined || val === "") return 0;
      const s = String(val).replace(/,/g, "").trim();
      const n = parseInt(s, 10);
      return Number.isFinite(n) ? n : 0;
    };

    // Simple CSV parser with quoted fields support
    function parseCSV(csvText) {
      const lines = csvText.replace(/\r/g, "").split("\n");
      if (!lines.length) return [];
      const headers = lines[0].split(","); // assume no commas in header names

      const out = [];
      for (let i = 1; i < lines.length; i++) {
        let line = lines[i];
        if (!line || !line.trim()) continue;

        const row = [];
        let cur = "", inQuotes = false;
        for (let j = 0; j < line.length; j++) {
          const ch = line[j];
          if (ch === '"' && line[j + 1] === '"') { cur += '"'; j++; continue; }
          if (ch === '"') { inQuotes = !inQuotes; continue; }
          if (ch === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
          cur += ch;
        }
        row.push(cur);

        const obj = {};
        headers.forEach((h, idx) => { obj[h.trim()] = (row[idx] ?? "").trim(); });
        // Coerce known numeric fields
        obj["Monthly Total (USD)"] = currencyToNumber(obj["Monthly Total (USD)"]);
        obj["Planned Revenue (USD)"] = currencyToNumber(obj["Planned Revenue (USD)"]);
        obj["Planned ARPU (USD)"] = currencyToNumber(obj["Planned ARPU (USD)"]);
        obj["ARPU (USD)"] = currencyToNumber(obj["ARPU (USD)"]);
        obj["Planned kWh"] = currencyToNumber(obj["Planned kWh"]);
        obj["Consumed kWh"] = currencyToNumber(obj["Consumed kWh"]);
        obj["Consumption per user"] = currencyToNumber(obj["Consumption per user"]);
        obj["Vending Customers"] = intOrZero(obj["Vending Customers"]);
        obj["Active Customers"] = intOrZero(obj["Active Customers"]);
        obj["Total Customers"] = intOrZero(obj["Total Customers"]);
        out.push(obj);
      }
      return out;
    }

    function populateFilter(selectId, values) {
      const sel = document.getElementById(selectId);
      const current = sel.value;
      sel.innerHTML = "";
      const makeOpt = (v, label) => {
        const o = document.createElement("option");
        o.value = v; o.textContent = label ?? v;
        sel.appendChild(o);
      };
      if (selectId === "siteFilter") makeOpt("__ALL__", "All sites");
      if (selectId === "monthFilter") makeOpt("__ALL__", "All months");
      values.forEach(v => makeOpt(v, v));
      if ([...sel.options].some(o => o.value === current)) sel.value = current;
    }

    function updateSummaryCards() {
      const siteRows = filteredData.filter(d => d["Site Name"] && d["Site Name"] !== "All sites");
      const totalRevenue = siteRows.reduce((s, r) => s + (r["Monthly Total (USD)"] || 0), 0);
      const totalEnergy = siteRows.reduce((s, r) => s + (r["Consumed kWh"] || 0), 0);
      const totalCustomers = siteRows.reduce((s, r) => s + (r["Active Customers"] || 0), 0);

      const arpus = siteRows.map(r => r["ARPU (USD)"]).filter(x => Number.isFinite(x));
      const avgARPU = arpus.length ? arpus.reduce((s, x) => s + x, 0) / arpus.length : 0;

      document.getElementById("totalRevenue").textContent = totalRevenue.toLocaleString("en-US", {style:"currency", currency:"USD", maximumFractionDigits:0});
      document.getElementById("totalEnergy").textContent = totalEnergy.toLocaleString("en-US");
      document.getElementById("totalCustomers").textContent = totalCustomers.toLocaleString("en-US");
      document.getElementById("avgARPU").textContent = avgARPU.toLocaleString("en-US", {style:"currency", currency:"USD"});
    }

    function processDataAndRender() {
      updateSummaryCards();
      renderRevenueTrend();
      renderRevenueBySite();
      renderEnergyCompare();
      renderCustomersBySite();
      renderTable();
    }

    function renderRevenueTrend() {
      const monthly = {};
      filteredData.forEach(r => {
        if (r["Site Name"] === "All sites") return;
        const m = r["Month"];
        monthly[m] = (monthly[m] || 0) + (r["Monthly Total (USD)"] || 0);
      });
      const labels = Object.keys(monthly).sort();
      const values = labels.map(k => monthly[k]);

      const ctx = document.getElementById("revenueChart").getContext("2d");
      if (revenueChart) revenueChart.destroy();
      revenueChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Monthly Revenue", data: values, fill: true }] },
        options: { responsive: true, maintainAspectRatio: true
                 }
      });
    }

    function renderRevenueBySite() {
      const bySite = {};
      filteredData.forEach(r => {
        if (r["Site Name"] === "All sites") return;
        const s = r["Site Name"];
        bySite[s] = (bySite[s] || 0) + (r["Monthly Total (USD)"] || 0);
      });
      const labels = Object.keys(bySite);
      const values = labels.map(k => bySite[k]);

      const ctx = document.getElementById("siteRevenueChart").getContext("2d");
      if (siteRevenueChart) siteRevenueChart.destroy();
      siteRevenueChart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Revenue by Site", data: values }] },
        options: { responsive: true, maintainAspectRatio: true }
      });
    }

    function renderEnergyCompare() {
      const bySite = {};
      filteredData.forEach(r => {
        if (r["Site Name"] === "All sites") return;
        const s = r["Site Name"];
        if (!bySite[s]) bySite[s] = { planned: 0, consumed: 0 };
        bySite[s].planned += r["Planned kWh"] || 0;
        bySite[s].consumed += r["Consumed kWh"] || 0;
      });
      const labels = Object.keys(bySite);
      const planned = labels.map(k => bySite[k].planned);
      const consumed = labels.map(k => bySite[k].consumed);

      const ctx = document.getElementById("energyChart").getContext("2d");
      if (energyChart) energyChart.destroy();
      energyChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Planned kWh", data: planned },
            { label: "Consumed kWh", data: consumed }
          ]
        },
        options: { responsive: true, maintainAspectRatio: true }
      });
    }

    function renderCustomersBySite() {
      const bySite = {};
      filteredData.forEach(r => {
        if (r["Site Name"] === "All sites") return;
        const s = r["Site Name"];
        bySite[s] = (bySite[s] || 0) + (r["Active Customers"] || 0);
      });
      const labels = Object.keys(bySite);
      const values = labels.map(k => bySite[k]);

      const ctx = document.getElementById("customersChart").getContext("2d");
      if (customersChart) customersChart.destroy();
      customersChart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Active Customers", data: values }] },
        options: { responsive: true, maintainAspectRatio: true }
      });
    }

    function renderTable() {
      if (!allData.length) return;
      const head = document.getElementById("tableHead");
      const body = document.getElementById("tableBody");
      head.innerHTML = ""; body.innerHTML = "";

      const headers = Object.keys(allData[0]);
      const trh = document.createElement("tr");
      headers.forEach(h => { const th = document.createElement("th"); th.textContent = h; trh.appendChild(th); });
      head.appendChild(trh);

      filteredData.forEach(r => {
        const tr = document.createElement("tr");
        headers.forEach(h => {
          const td = document.createElement("td");
          td.textContent = r[h];
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    function applyFilters() {
      const siteSel = document.getElementById("siteFilter").value;
      const monthSel = document.getElementById("monthFilter").value;

      filteredData = allData.filter(r => {
        const okSite = (siteSel === "__ALL__") || (r["Site Name"] === siteSel);
        const okMonth = (monthSel === "__ALL__") || (r["Month"] === monthSel);
        return okSite && okMonth;
      });

      processDataAndRender();
    }

    function initFilters() {
      const sites = [...new Set(allData.map(r => r["Site Name"]).filter(s => s && s !== "All sites"))].sort();
      const months = [...new Set(allData.map(r => r["Month"]).filter(Boolean))].sort();
      populateFilter("siteFilter", sites);
      populateFilter("monthFilter", months);
      document.getElementById("siteFilter").addEventListener("change", applyFilters);
      document.getElementById("monthFilter").addEventListener("change", applyFilters);
    }

    async function loadData() {
      const resp = await fetch(CSV_URL, { cache: "no-store" });
      if (!resp.ok) throw new Error("Failed to load CSV: " + resp.status);
      const csv = await resp.text();
      allData = parseCSV(csv);
      filteredData = [...allData];
      initFilters();
      processDataAndRender();
    }

    // Kickoff
    loadData().catch(err => {
      console.error(err);
      alert("Failed to load dashboard data. Please ensure the Google Sheet is shared or published for CSV access.");
    });
  </script>
</body>
</html>

